\subsection{Theory}\label{sec:m3:theory}

\subsubsection{Metric perturbations}
    The perturbed metric in the conformal-Newtonian gauge is given in ~\cite{https://doi.org/10.48550/arxiv.astro-ph/0606683} as:
    \begin{equation}\label{eq:m3:theory:perturbed_metric}
        g_\munu = \begin{pmatrix}
            -(1+2\Psi) & 0 \\
            0 & e^{2x}\delta_{ij}(1+2\Phi)
        \end{pmatrix}
    \end{equation}
    This means that we perturb the FLRW-metric with $\Psi\ll1$ corresponding to the Newtonian potential governing the motion of non-relativistic particles and $\Phi\ll1$ governing the perturbation of the spatial curvature. \footnote{$\Phi$ may also be interpreted as a \textit{local perturbation to the scale factor}, ~\cite{dodelson2020modern}.} The comoving momentum in this spacetime is:
    \begin{equation}
        P^\mu = \left[E(1-\Psi), p^i\frac{1-\Phi}{a}\right].
    \end{equation}
    By considering this momentum, and the geodesic equation in this perturbed spacetime we obtain the following ~\cite[Eqs. 3.62, 3.69, 3.71]{dodelson2020modern}:
    \begin{subequations}\label{eq:m3:theory:geodesic_results}
        \begin{align}
            \dv{x^i}{t} &= \frac{\hat{p}^i}{a}\frac{p}{E}(1-\Phi+\Psi) \label{eq:m3:theory:metric_perturb_dxidt}\\
            \dv{p^i}{t} &= -\left(H+\dv{\Phi}{t}\right)p^i-\frac{E}{a}\pdv{\Phi}{x^i}-\frac{1}{a}\frac{p^i}{E}p^k\pdv{\Phi}{x^k} + \frac{p^2}{aE}\pdv{\Phi}{x^i} \label{eq:m3:theory:metric_perturb_dpidt}\\
            \dv{p}{t} &= -\left(H+\dv{\Phi}{t}\right)p-\frac{E}{a}\hat{p}^i\pdv{\Psi}{x^i} \label{eq:m3:theory:metric_perturb_dpdt}
        \end{align}
    \end{subequations}
    Inserting ~\cref{eq:m3:theory:geodesic_results} into ~\cref{eq:m2:theory:bolzmann_expanded}, and for now assuming $C[f]=0$ yield the \textit{collisionless Bolzmann equations}. Keeping terms to first order only,\footnote{This is justified by the ansatz that deviations away from the equilibrium distribution of radiation in the inhomogeneous universe are of same order as the spacetime perturbations $\Phi$ and $\Psi$, ~\cite{dodelson2020modern}.} yield the collisionless Bolzmann equation: ~\cite[Eq. 3.83]{dodelson2020modern}:
    \begin{equation}\label{eq:m3:theory:collisionless_bolzmann_general}
        \dv{f}{t} = \pdv{f}{t}+\frac{p}{E}\frac{\hat{p}^i}{a}\pdv{f}{x^i}-\left[H+\dv{\Phi}{t} + \frac{E}{ap}\hat{p}^i\pdv{\Psi}{x^i}\right]p\pdv{f}{p}.
    \end{equation}
    Future work consists mainly of evaluating the collision terms for each species and equate it to ~\cref{eq:m3:theory:collisionless_bolzmann_general}

\subsubsection{Fourier space and multipole expansion}
    Consider a function $f(\vec{x},t)$. Its Fourier transform $\FF$ and inverse $\FF^{-1}$ are defined as:
    \begin{equation}\label{eq:m3:theory:fourier_def}
            \FF[f(\vec{x},t)]  \equiv \frac{1}{(2\pi)^{3/2}}\int e^{-i\vec{k}\cdot\vec{x}}f(\vec{x},t)\d^3 x = \tilde{f}(\vec{k},t),
    \end{equation}
    \begin{equation}\label{eq:m3:theory:fourier_inv_def}
        \FF^{-1}[\tilde{f}(\vec{k},t)] \equiv \frac{1}{(2\pi)^{3/2}}\int e^{i\vec{k}\cdot\vec{x}}\tilde{f}(\vec{k},t)\d^3 k = f(\vec{x},t).
    \end{equation}
    It becomes apparent from these definitions that taking the spatial derivative with respect to $\vec{x}$ in real space, is the same as multiplying the function with $i\vec{k}$ in Fourier space. This leads to the following property: $\FF[\nabla f(\vec{x},t)] = i\vec{k}\FF[f(\vec{x},t)]$. This is of major significance when working with partial differential equations (PDEs), where:
    \begin{equation}\label{eq:m3:theory:fourier_pde_tricks}
        \begin{split}
            \FF[\nabla^2f(\vec{x},t)] &= i^2\vec{k}\cdot\vec{k}\FF[f(\vec{x},t)] = -k^2\FF[f(\vec{x},t)]\\
            \FF\left[\dv[n]{f(\vec{x},t)}{t}\right] &= \dv[n]{t}\FF[f(\vec{x},t)].
        \end{split}
    \end{equation} 
    The two equations in ~\cref{eq:m3:theory:fourier_pde_tricks} have the ability of reducing PDEs down to a set of decoupled ODEs. This means that we are able to solve for each mode $k=\abs{\vec{k}}$ independently, which will be of great impact for the equations to come. 

    We will also work with multipole expansions, which are series written as sums of \textit{Legendre polynomials} expanded in $\mu=\cos{\theta}\in[-1,1]$ as:
    \begin{equation}\label{eq:m3:theory:legendre_expansion}
        f(\mu) = \sum_{l=0}^{\infty}f_l\mathcal{P}_l(\mu),
    \end{equation}
    where $\mathcal{P}_l$ is the $l$-th Legendre polynomial. These are orthogonal in such a way that they form a complete basis, enabling us to express any $f(\mu)$ as in ~\cref{eq:m3:theory:legendre_expansion}. The coefficients $f_l$ are the \textit{Legendre multipoles}:
    \begin{equation}\label{eq:m3:theory:legendre_coeff}
        f_l = \frac{2l+1}{2}\int_{-1}^1f(\mu)\mathcal{P}_l(\mu)\d\mu.
    \end{equation}




\subsubsection{Einstein-Boltzmann equations}
    We have two perturbations to the metric, $\Phi(\vec{x}, t)$ to the spatial curvature, and $\Psi(\vec{x},t)$ to the Newtonian potential. We seek to find the effect of these perturbations on baryonic matter, dark energy and radiation, as they ``live'' in a now perturbed spacetime. Let's start by defining the perturbation to the photons, $\T(\vec{x}, \hat{\vec{p}}, t)$, to be the variation of photon temperature around an equilibrium temperature $T^{(0)}$:
    \begin{equation}\label{eq:m3:theory:temperature_perturbation}
        T(\vec{x}, \hat{\vec{p}}, t) = T^{(0)}\left[1+\T(\vec{x}, \hat{\vec{p}}, t)\right].
    \end{equation}
    This is dependent on the location $\vec{x}$ and the direction of propagation $\hat{\vec{p}}$, thus capturing both inhomogeneities and anisotropies. We assume $\T$ to be independent of the momentum magnitude.\footnote{This follows from the fact that the magnitude of the photon momentum is virtually unchanged by the dominant form of interaction, Compton scattering ~\cite{dodelson2020modern}.}
    The collision terms for the photons are governed by Compton scattering. We use the form found in ~\cite[Eq. 5.22]{dodelson2020modern}\TODO{assumptions: ignore polarisation, and angular dep. of thomson cross sec}:
    \begin{equation}\label{eq:m3:theory:photon_collision_term}
        C[f(\vec{p})] = -p^2\pdv{f^{(0)}}{p}n_e\sigma_T[\T_0 - \T(\hat{\vec{p}}) + \hat{\vec{p}}\cdot\vec{v}_b]
    \end{equation}
    where $\T_0$ is the monopole term.\footnote{This is the integral over the photon perturbation at any given point, over all photon directions. It is given by $$\T_0(\vec{x}, t) \equiv \frac{1}{4\pi}\int \d\Omega'\T(\vec{x}, \hat{\vec{p}}', t)$$ where $\O'$ is the solid angle spanned by $\hat{\vec{p}}'$ ~\cite{dodelson2020modern}.} The distribution function for radiation follows the Bose-Einstein distribution function, so we expand $f$ around its zeroth order Bose-Einstein form, ~\cite[Eq. 5.2-5.9]{dodelson2020modern}, using the temperature perturbation in ~\cref{eq:m3:theory:temperature_perturbation}\TODO{Include equation 5.9 in Dodelson?}. This is then inserted into ~\cref{eq:m3:theory:collisionless_bolzmann_general}, which we equate to the collision term in ~\cref{eq:m3:theory:photon_collision_term} in order to obtain the following full Boltzmann equation for radiation:
    \begin{equation}\label{eq:m3:theory:boltzmann_equation_radiation_full}
        \dv{\T}{t} + \frac{\hat{p}^i}{a}\pdv{\T}{x^i} + \dv{\Phi}{t} + \frac{\hat{p}^i}{a}\pdv{\Psi}{x^i} = n_e\sigma_T\left[\T_0-\T+\vec{\hat{p}}\cdot\vec{v}_b\right]
    \end{equation} 


    from ~\cite[Eq. 3.76]{dodelson2020modern}:
    \begin{equation}\label{eq:m3:theory:boltzmann_for_massive_particles}
        \dv{f}{t} = \pdv{f}{t}+\frac{p}{E}\frac{\hat{p}^i}{a}\pdv{f}{x^i} - \left[H+\dot{\Psi}+\frac{E}{ap}\hat{p}^i\Psi_i\right]p\pdv{f}{p}
    \end{equation}


     

    \begin{subequations}
        \begin{align}
            \dot{\T} &= -ik\mu(\T+\Psi)-\dot{\Phi}-\dot{\tau}\left[\T_0-\T+i\mu v_b-\frac{\mathcal{P}_2\T_2}{2}\right],\\
            \dot{\delta}_\cdm &= -3\dot{\Phi}+kv_\cdm \\
            \dot{v}_\cdm &= -k\Psi-\Hp v_\cdm \\
        \end{align}
    \end{subequations}

    
    Photon temperature multipoles
    \begin{subequations}\label{eq:m3:theory:photon_temp_multipoles}
        \begin{align}
            \T_0' &= -\frac{ck}{\Hp}\T_1-\Phi',\label{eq:m3:theory:photon_monopole}\\
            \T_1' &= \frac{ck}{3\Hp}\T_0 - \frac{2ck}{3\Hp}\T_2 +\frac{ck}{3\Hp}\Psi+\tau'\left[\T_1+\frac{1}{3}v_b\right],\label{eq:m3:theory:photon_dipole}\\
            \T_l &= \begin{cases}
                \frac{lck\T_{l-1}}{(2l+1)\Hp} -\frac{(l+1)ck\T_{l+1}}{(2l+1)\Hp} +\tau'\left[\T_l-\frac{\T_2}{10}\delta_{l,2}\right] , \quad &l\geq2\\
                \\
                \frac{ck\T_{l-1}}{\Hp} - c\frac{(l+1)\T_l}{\Hp\eta}+\tau'\T_l, &l=l_\mathrm{max}
            \end{cases}\label{eq:m3:theory:photon_multipole}
        \end{align}
    \end{subequations}


    
    Cold dark matter and baryons
    \begin{subequations}\label{eq:m3:theory:cdm_baryon_diffeqs}
        \begin{align}
            \delta'_\cdm &= \frac{ck}{\Hp}v_\cdm-3\Phi', \label{eq:m3:theory:delta_cdm}\\
            v'_\cdm &= -v_\cdm-\frac{ck}{\Hp}\Psi, \label{eq:m3:theory:v_cdm}\\
            \delta'_b &= \frac{ck}{\Hp}v_b - 3\Phi', \label{eq:m3:theory:delta_b}\\
            v'_b &= -v_b - \frac{ck}{\Hp} + \tau'R^{-1}(3\T_1+v_b) \label{eq:m3:theory:v_b}
        \end{align}
    \end{subequations}
    where $R$ is defined in ~\cref{eq:m2:theory:sound_speed}


    Metric perturbations

    \begin{subequations}\label{eq:m3:theory:metric_perturbations_final}
        \begin{align}
            \Phi' &= \Psi - \frac{c^2k^2}{3\Hp^2}\Phi + \frac{H_0^2}{2\Hp^2}\mathcal{Y}, \label{eq:m3:theory:phi_perturbation}\\
            \Psi &= -\Phi - \frac{12H_0^2}{c^2k^2}\O_\gamma\T_2. \label{eq:m3:theory:psi_perturbation}
        \end{align}
    \end{subequations}
    where $\mathcal{Y} = \O_\cdm\delta_\cdm+\O_b\delta_b+4\O_\gamma\T_0$

\subsubsection{Tight coupling regime}

\subsubsection{Inflation}
\subsubsection{Initial conditions}
