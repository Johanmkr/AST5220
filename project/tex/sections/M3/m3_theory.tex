\subsection{Theory}\label{sec:m3:theory}

\subsubsection{Metric perturbations}
    The perturbed metric in the conformal-Newtonian gauge is given in ~\cite{https://doi.org/10.48550/arxiv.astro-ph/0606683} as:
    \begin{equation}\label{eq:m3:theory:perturbed_metric}
        g_\munu = \begin{pmatrix}
            -(1+2\Psi) & 0 \\
            0 & e^{2x}\delta_{ij}(1+2\Phi)
        \end{pmatrix}
    \end{equation}
    This means that we perturb the FLRW-metric with $\Psi\ll1$ corresponding to the Newtonian potential governing the motion of non-relativistic particles and $\Phi\ll1$ governing the perturbation of the spatial curvature. \footnote{$\Phi$ may also be interpreted as a \textit{local perturbation to the scale factor}, ~\cite{dodelson2020modern}.} The comoving momentum in this spacetime is:
    \begin{equation}
        P^\mu = \left[E(1-\Psi), p^i\frac{1-\Phi}{a}\right].
    \end{equation}
    By considering this momentum, and the geodesic equation in this perturbed spacetime we obtain the following ~\cite[Eqs. 3.62, 3.69, 3.71]{dodelson2020modern}:
    \begin{subequations}\label{eq:m3:theory:geodesic_results}
        \begin{align}
            \dv{x^i}{t} &= \frac{\hat{p}^i}{a}\frac{p}{E}(1-\Phi+\Psi) \label{eq:m3:theory:metric_perturb_dxidt}\\
            \dv{p^i}{t} &= -\left(H+\dv{\Phi}{t}\right)p^i-\frac{E}{a}\pdv{\Phi}{x^i}-\frac{1}{a}\frac{p^i}{E}p^k\pdv{\Phi}{x^k} + \frac{p^2}{aE}\pdv{\Phi}{x^i} \label{eq:m3:theory:metric_perturb_dpidt}\\
            \dv{p}{t} &= -\left(H+\dv{\Phi}{t}\right)p-\frac{E}{a}\hat{p}^i\pdv{\Psi}{x^i} \label{eq:m3:theory:metric_perturb_dpdt}
        \end{align}
    \end{subequations}
    Inserting ~\cref{eq:m3:theory:geodesic_results} into ~\cref{eq:m2:theory:bolzmann_expanded}, and for now assuming $C[f]=0$ yield the \textit{collisionless Bolzmann equations}. Keeping terms to first order only,\footnote{This is justified by the ansatz that deviations away from the equilibrium distribution of radiation in the inhomogeneous universe are of same order as the spacetime perturbations $\Phi$ and $\Psi$, ~\cite{dodelson2020modern}.} yield the collisionless Bolzmann equation: ~\cite[Eq. 3.83]{dodelson2020modern}:
    \begin{equation}\label{eq:m3:theory:collisionless_bolzmann_general}
        \dv{f}{t} = \pdv{f}{t}+\frac{p}{E}\frac{\hat{p}^i}{a}\pdv{f}{x^i}-\left[H+\dv{\Phi}{t} + \frac{E}{ap}\hat{p}^i\pdv{\Psi}{x^i}\right]p\pdv{f}{p}.
    \end{equation}
    Future work consists mainly of evaluating the collision terms for each species and equate it to ~\cref{eq:m3:theory:collisionless_bolzmann_general}

\subsubsection{Fourier space and multipole expansion}
    Consider a function $f(\vec{x},t)$. Its Fourier transform $\FF$ and inverse $\FF^{-1}$ are defined as:
    \begin{equation}\label{eq:m3:theory:fourier_def}
            \FF[f(\vec{x},t)]  \equiv \frac{1}{(2\pi)^{3/2}}\int e^{-i\vec{k}\cdot\vec{x}}f(\vec{x},t)\d^3 x = \tilde{f}(\vec{k},t),
    \end{equation}
    \begin{equation}\label{eq:m3:theory:fourier_inv_def}
        \FF^{-1}[\tilde{f}(\vec{k},t)] \equiv \frac{1}{(2\pi)^{3/2}}\int e^{i\vec{k}\cdot\vec{x}}\tilde{f}(\vec{k},t)\d^3 k = f(\vec{x},t).
    \end{equation}
    It becomes apparent from these definitions that taking the spatial derivative with respect to $\vec{x}$ in real space, is the same as multiplying the function with $i\vec{k}$ in Fourier space. This leads to the following property: $\FF[\nabla f(\vec{x},t)] = i\vec{k}\FF[f(\vec{x},t)]$. This is of major significance when working with partial differential equations (PDEs), where:
    \begin{equation}\label{eq:m3:theory:fourier_pde_tricks}
        \begin{split}
            \FF[\nabla^2f(\vec{x},t)] &= i^2\vec{k}\cdot\vec{k}\FF[f(\vec{x},t)] = -k^2\FF[f(\vec{x},t)]\\
            \FF\left[\dv[n]{f(\vec{x},t)}{t}\right] &= \dv[n]{t}\FF[f(\vec{x},t)].
        \end{split}
    \end{equation} 
    The two equations in ~\cref{eq:m3:theory:fourier_pde_tricks} have the ability of reducing PDEs down to a set of decoupled ODEs. This means that we are able to solve for each mode $k=\abs{\vec{k}}$ independently, which will be of great impact for the equations to come. 

    We will also work with multipole expansions, which are series written as sums of \textit{Legendre polynomials} expanded in $\mu=\cos{\theta}\in[-1,1]$ as:
    \begin{equation}\label{eq:m3:theory:legendre_expansion}
        f(\mu) = \sum_{l=0}^{\infty}\frac{2l+1}{i^l}f_l\mathcal{P}_l(\mu),
    \end{equation}
    where $\mathcal{P}_l$ is the $l$-th Legendre polynomial. These are orthogonal in such a way that they form a complete basis, enabling us to express any $f(\mu)$ as in ~\cref{eq:m3:theory:legendre_expansion}. The coefficients $f_l$ are the \textit{Legendre multipoles}:
    \begin{equation}\label{eq:m3:theory:legendre_coeff}
        f_l = \frac{i^l}{2}\int_{-1}^1f(\mu)\mathcal{P}_l(\mu)\d\mu.
    \end{equation}
    The factors $(2l+1)/i^l$ in ~\cref{eq:m3:theory:legendre_expansion} and $i^l/2$ in ~\cref{eq:m3:theory:legendre_coeff} are just conventional choices. It is convenient to expand functions in this way when we are considering quantities that are function of a direction in the sky - since the Legendre polynomials are closely related to the spherical harmonics, which is a natural choice of basis for such quantities. 




\subsubsection{Einstein-Boltzmann equations}
    We have two perturbations to the metric, $\Phi(\vec{x}, t)$ to the spatial curvature, and $\Psi(\vec{x},t)$ to the Newtonian potential. We seek to find the effect of these perturbations on baryonic matter, dark energy and radiation, as they ``live'' in a now perturbed spacetime. Let's start by defining the perturbation to the photons, $\T(\vec{x}, \hat{\vec{p}}, t)$, to be the variation of photon temperature around an equilibrium temperature $T^{(0)}$:
    \begin{equation}\label{eq:m3:theory:temperature_perturbation}
        T(\vec{x}, \hat{\vec{p}}, t) = T^{(0)}\left[1+\T(\vec{x}, \hat{\vec{p}}, t)\right].
    \end{equation}
    This is dependent on the location $\vec{x}$ and the direction of propagation $\hat{\vec{p}}$, thus capturing both inhomogeneities and anisotropies. We assume $\T$ to be independent of the momentum magnitude.\footnote{This follows from the fact that the magnitude of the photon momentum is virtually unchanged by the dominant form of interaction, Compton scattering ~\cite{dodelson2020modern}.}
    The collision terms for the photons are governed by Compton scattering. We use the form found in ~\cite[Eq. 5.22]{dodelson2020modern}\TODO{assumptions: ignore polarisation, and angular dep. of thomson cross sec}:
    \begin{equation}\label{eq:m3:theory:photon_collision_term}
        C[f(\vec{p})] = -p^2\pdv{f^{(0)}}{p}n_e\sigma_T[\T_0 - \T(\hat{\vec{p}}) + \hat{\vec{p}}\cdot\vec{v}_b]
    \end{equation}
    where $\T_0$ is the monopole term.\footnote{This is the integral over the photon perturbation at any given point, over all photon directions. It is given by $$\T_0(\vec{x}, t) \equiv \frac{1}{4\pi}\int \d\Omega'\T(\vec{x}, \hat{\vec{p}}', t)$$ where $\O'$ is the solid angle spanned by $\hat{\vec{p}}'$ ~\cite{dodelson2020modern}.} $\vec{v}_b$ is the bulk velocity of the electrons involved in the process, and is the same as for baryons, hence the subscript. The distribution function for radiation follows the Bose-Einstein distribution function, so we expand $f$ around its zeroth order Bose-Einstein form, ~\cite[Eq. 5.2-5.9]{dodelson2020modern}, using the temperature perturbation in ~\cref{eq:m3:theory:temperature_perturbation}\TODO{Include equation 5.9 in Dodelson?}. This is then inserted into ~\cref{eq:m3:theory:collisionless_bolzmann_general}, which we equate to the collision term in ~\cref{eq:m3:theory:photon_collision_term} in order to obtain the following full Boltzmann equation for radiation:\footnote{Where of course $m=0\iff E=p$.}
    \begin{equation}\label{eq:m3:theory:boltzmann_equation_radiation_full}
        \dv{\T}{t} + \frac{\hat{p}^i}{a}\pdv{\T}{x^i} + \dv{\Phi}{t} + \frac{\hat{p}^i}{a}\pdv{\Psi}{x^i} = n_e\sigma_T\left[\T_0-\T+\vec{\hat{p}}\cdot\vec{v}_b\right]
    \end{equation} 
    
    For massive particles, we start with cold dark matter (CDM). Firstly, we assume cold dark matter to not interact with any other species, nor self-interact. Thus, we do not have any collision terms. Further, we also assume it to behave like a fluid, neglecting any terms not to first order. We consider cold dark matter to be non-relativistic, thus they will only have a sizeable monopole and dipole term, which means that the evolution is fully characterised by the density and velocity, ~\cite{AST5220LectureNotes}. \TODO{how much about moments should I explain?} Therefore, we take the first and second moment of ~\cref{eq:m3:theory:collisionless_bolzmann_general} and consider them to first order, in order to retrieve the cosmological generalisation of the continuity equation ~\cite[Eq. 5.41]{dodelson2020modern}:
    \begin{equation}\label{eq:m3:theory:cdm_continuity_equation}
        \pdv{n_c}{t}+\frac{1}{a}\pdv{(n_cv_c^i)}{x^i} + 3\left[H+\pdv{\Phi}{t}\right]n_c=0,
    \end{equation}
    and the Euler equation ~\cite[Eq. 5.50]{dodelson2020modern}:
    \begin{equation}\label{eq:m3:theory:cdm_euler_equation}
        \pdv{v_c^i}{t} + Hv_c^i + \frac{1}{a}\pdv{\Psi}{x^i} = 0.
    \end{equation}
    In both ~\cref{eq:m3:theory:cdm_continuity_equation} and ~\cref{eq:m3:theory:cdm_euler_equation}, $n_c$ is the cold dark matter number density, $\vec{v}_c$ its bulk velocity. We then consider the perturbation of $n_c$ to first order:
    \begin{equation}\label{eq:m3:theory:cdm_number_density_perturbation}
        n_c(\vec{x}, t) = n_c^{(0)}[1+\delta_c(\vec{x},t)],
    \end{equation}
    and consider the first order perturbation to ~\cref{eq:m3:theory:cdm_continuity_equation}:
    \begin{equation}\label{eq:m3:theory:cdm_density_perturbation}
        \pdv{\delta_c}{t}+\frac{1}{a}\pdv{v_c^i}{x^i} + 3\pdv{\Phi}{t} = 0.
    \end{equation}
    ~\cref{eq:m3:theory:cdm_density_perturbation} and ~\cref{eq:m3:theory:cdm_euler_equation} now described the evolution of the density perturbation $\delta_c$ and bulk velocity $\vec{v}_c$ of cold dark matter.

    For baryons (protons and electrons) we also assume them to behave like a non-relativistic fluid, so taking moments is a similar task as for cold dark matter. The only difference is that baryons interact with each other through Coulomb scattering and Compton scattering. We may ignore Compton scattering between protons and photons due to the small cross-section, but electrons are coupled to both photons and protons. Since the first moment of the Boltzmann equation represents conservations of particle number, and none of the above interactions changes the total baryon particle number, the continuity equation is identical to ~\cref{eq:m3:theory:cdm_continuity_equation}, but for baryons. We also have a baryon perturbation similar to ~\cref{eq:m3:theory:cdm_number_density_perturbation}, which altogether results in the following density perturbation for baryons:
    \begin{equation}\label{eq:m3:theory:baryon_density_perturbation}
        \pdv{\delta_b}{t}+\frac{1}{a}\pdv{v_b^i}{x^i} + 3\pdv{\Phi}{t} = 0.
    \end{equation}
    For the Euler equation, we now have to consider the collision terms, where momentum is conserved, but transferred between the baryons and photons. This collision term is found from considering the first moment of the photon distribution and find the momentum transfer due to Compton scattering. According to ~\cite{AST5220LectureNotes} the momentum transfer in the baryon equation is $-n_e\sigma_TR^{-1}(v_\gamma^i-v_b^i)$, where $R$ is defined in ~\cref{eq:m2:theory:sound_speed}. The Euler equation for baryons, similar to ~\cref{eq:m3:theory:cdm_euler_equation}, but with the momentum transfer as source term now yield:
    \begin{equation}\label{eq:m3:theory:baryon_euler_equation}
        \pdv{v_b^i}{t}+Hv_b^i + \frac{1}{a}\pdv{\Psi}{x^i} = -n_e\sigma_TR^{-1}(v_\gamma^i-v_b^i)
    \end{equation}

    We have now acquired differential equations for the temperature fluctuations, $\T$ in ~\cref{eq:m3:theory:boltzmann_equation_radiation_full}, and the overdensities\footnote{The fluctuations to the equilibrium densities.}, $\delta_c$, $\delta_b$, and bulk velocities $v_c^i$ and $v_b^i$, of cold dark matter and baryons respectively in ~\cref{eq:m3:theory:cdm_density_perturbation}, ~\cref{eq:m3:theory:baryon_density_perturbation}, ~\cref{eq:m3:theory:cdm_euler_equation} and ~\cref{eq:m3:theory:baryon_euler_equation}. In order to make these differential equations easier to solve we make the transformation into Fourier space. We do this by introducing $\mu$ as the cosine of the angle between the Fourier wave vector $\vec{k}$ and the direction of the photon $\vec{p}/\abs{\vec{p}}$. Additionally, velocities are generally longitudinal which enables us to write:
    \begin{equation}\label{eq:m3:theory:mu_and_longitudinal_vel_def}
        \begin{split}
            \mu &\equiv \frac{\vec{k}\cdot\vec{p}}{kp} \\
            \vec{v} &= i\hat{\vec{k}}v
        \end{split}
    \end{equation}
    This enables us to summarise the differential equations as follows, now in Fourier space, and the time derivative is with respect to conformal time $\eta$:
    \begin{subequations}\label{eq:m3:theory:diff_eqs_fourier_conformal}
        \begin{align}
            \dot{\T} &= -ik\mu(\T+\Psi)-\dot{\Phi}-\dot{\tau}\left[\T_0-\T+i\mu v_b-\frac{\mathcal{P}_2\T_2}{2}\right], \label{eq:m3:theory:diff_eq_FC_theta}\\
            \dot{\delta}_c &= -3\dot{\Phi}+kv_c, \label{eq:m3:theory:diff_eq_FC_delta_c}\\
            \dot{v}_c &= -k\Psi-\Hp v_c, \label{eq:m3:theory:diff_eq_FC_v_c}\\
            \dot{\delta}_b &= -3\dot{\Phi} + kv_b, \label{eq:m3:theory:diff_eq_FC_delta_b}\\
            \dot{v}_b &= -k\Psi + \dot{\tau}R^{-1}(v_b+3\T_1) - \Hp v_b. \label{eq:m3:theory:diff_eq_FC_v_b}
        \end{align}
    \end{subequations}
    In ~\cref{eq:m3:theory:diff_eq_FC_theta} and ~\cref{eq:m3:theory:diff_eq_FC_v_b} we define $\dot{\tau}$ from ~\cref{eq:m2:theory:optical_depth}. Additionally, in ~\cref{eq:m3:theory:diff_eq_FC_theta} we have included the term $\mathcal{P}_2\T_2/2$ in order to account for the angular dependency of Compton scattering previously ignored. We have also used that the photon velocity is proportional to the dipole $\T_1 = -v_\gamma/3$.

    Our next step is to once again consider the perturbation to the metric in order to find out how the potentials $\Psi$ and $\Phi$ change with time. In short, this is done by computing the perturbed Christoffel symbols using ~\cref{eq:m3:theory:perturbed_metric}, finding the Ricci tensor and Ricci scalar, and construct the perturbed Einstein tensor. We also have to find the perturbed energy-momentum Tensor, and then solve the Einstein equation in ~\cref{eq:introduction:einstein_equation}. The result yields the time evolution of $\Phi$ and $\Psi$, where we have from ~\cite[Eq. 6.41]{dodelson2020modern}:
    \begin{equation}\label{eq:m3:theory:time_evolution_of_Phi}
        k^2\Phi+3\Hp(\dot{\Phi}-\Hp\Psi) = 4\pi Ga^2(\rho_c\delta_c+\rho_b\delta_b+4\rho_\gamma\T_0),
    \end{equation}
    and from ~\cite[Eq. 6.47]{dodelson2020modern}
    \begin{equation}\label{eq:m3:theory:Psi_Phi_connection}
        k^2(\Phi+\Psi) = -32\pi Ga^2(\rho_\gamma\T_2):
    \end{equation}
    ~\cref{eq:m3:theory:time_evolution_of_Phi} and ~\cref{eq:m3:theory:Psi_Phi_connection} are both written in Fourier space. The final step is to write the photon fluctuations $\T$ as a hierarchy of multipoles in accordance with ~\cref{eq:m3:theory:legendre_expansion}. The resultant hierarchy, along with all relevant equations, now written in terms of our preferred temporal variable $x$ is given below: 


    \begin{tcolorbox}[
        width=1.025\linewidth,
        colback=blue!5!white,
        colframe=white
    ]
    
    \textbf{Photon temperature multipoles}
    \begin{subequations}\label{eq:m3:theory:photon_temp_multipoles}
        \begin{align}
            \T_0' &= -\frac{ck}{\Hp}\T_1-\Phi',\label{eq:m3:theory:photon_monopole}\\
            \T_1' &= \frac{ck}{3\Hp}\T_0 - \frac{2ck}{3\Hp}\T_2 +\frac{ck}{3\Hp}\Psi+\tau'\left[\T_1+\frac{1}{3}v_b\right],\label{eq:m3:theory:photon_dipole}\\
            \T_l' &= \begin{cases}
                \frac{lck\T_{l-1}}{(2l+1)\Hp} -\frac{(l+1)ck\T_{l+1}}{(2l+1)\Hp} +\tau'\left[\T_l-\frac{\T_2}{10}\delta_{l,2}\right], &l\geq2\\
                \\
                \frac{ck\T_{l-1}}{\Hp} - c\frac{(l+1)\T_l}{\Hp\eta}+\tau'\T_l, &l=l_\mathrm{f}
            \end{cases}\label{eq:m3:theory:photon_multipole}
        \end{align}
    \end{subequations}
    \\
    \textbf{Cold dark matter and baryons}
    \begin{subequations}\label{eq:m3:theory:cdm_baryon_diffeqs}
        \begin{align}
            \delta'_c &= \frac{ck}{\Hp}v_c-3\Phi', \label{eq:m3:theory:delta_cdm}\\
            v'_c &= -v_c-\frac{ck}{\Hp}\Psi, \label{eq:m3:theory:v_cdm}\\
            \delta'_b &= \frac{ck}{\Hp}v_b - 3\Phi', \label{eq:m3:theory:delta_b}\\
            v'_b &= -v_b - \frac{ck}{\Hp}\Psi + \tau'R^{-1}(3\T_1+v_b) \label{eq:m3:theory:v_b}
        \end{align}
    \end{subequations}
    \\
    \textbf{Metric perturbations}
    \begin{subequations}\label{eq:m3:theory:metric_perturbations_final}
        \begin{align}
            \Phi' &= \Psi - \frac{c^2k^2}{3\Hp^2}\Phi + \frac{\mathcal{Y}}{2}, \label{eq:m3:theory:phi_perturbation}\\
            \Psi &= -\Phi - \frac{12\mathcal{H}^2}{c^2k^2}\O_\gamma\T_2. \label{eq:m3:theory:psi_perturbation}
        \end{align}
    \end{subequations}
    where $\mathcal{Y} = \O_c\delta_c+\O_b\delta_b+4\O_\gamma\T_0$ 

\end{tcolorbox}
\subsubsection{Tight coupling regime}
    The tight coupling regime represents the time in the early Universe, before recombination, when both radiation, dark matter and baryons were tightly coupled together, interactions where frequent and efficient, and the primordial plasma very optically thick ($\tau\gg1$). Due to this, the bulk velocity of the baryons (which co-moves with the other species due to the tight coupling) is very low. Furthermore, due to the frequent interactions and low bulk velocity the radiation dipole is suppressed. Altogether, this causes the combination $(3\T_1+v_b)$ to be very small. The optical depth changes rapidly in the tight coupling regime, as seen from ~\cref{fig:m2:optical_depth}, $\abs{\tau'}\gg1$. As a result, any combinations of the form $\tau'(\T_1+v_b)$, as they occur in ~\cref{eq:m3:theory:photon_dipole} and ~\cref{eq:m3:theory:v_b} are extremely numerically unstable. We therefore use said equations in order to rewrite for:
    \begin{equation}\label{eq:m3:theory:q_rewrite}
        q = \frac{ck}{\Hp}(\T_0-2\T_2) + \tau'(1+R^{-1})(3\T_1+v_b) - v_b,
    \end{equation}
    where we have defined 
    \begin{equation}\label{eq:m3:theory:q_def}
        q\equiv (3\T_1+v_b)' \implies \T_1'=(q-v_b')/3
    \end{equation}
    We are able to differentiate ~\cref{eq:m3:theory:q_rewrite} w.r.t. $x$ by using $(R^{-1})' = -R^{-1}$ in order to obtain:
    \begin{equation}\label{eq:m3:theory:q_derivative}
        \begin{split}
            q' &= \left[\tau''\left(1+R^{-1}\right)+\left(1-R^{-1}\right)\tau'\right](3\T_1+v_b)\\
            &+\left[\tau'\left(1+R^{-1}\right)-1\right]q \\
            &+\frac{ck}{\Hp}\left(\T_0-2\T_2+\Psi+\T_0'-2\T_2'-\frac{\Hp'}{\Hp}(\T_0-2\T_2)\right)
        \end{split}
    \end{equation}
    The treatment leading up to ~\cref{eq:m3:theory:q_derivative} is exact, but now we make the following approximation, ~\cite{AST5220LectureNotes}: In a radiation dominated universe (which is what we have in the tight coupling regime) we have that:
    \begin{equation}\label{eq:m3:theory:tight_coupling_approximation}
        \begin{split}
        \eta\propto a\propto \tau'^{-1}\propto(3\T_1+v_b) &\implies \dv[2]{\eta}(3\T_1+v_b)\approx 0 \\
        &\implies q' \approx -\frac{\Hp'}{\Hp}q
        \end{split}
    \end{equation}
    We find $q$ by equating ~\cref{eq:m3:theory:q_derivative} and ~\cref{eq:m3:theory:tight_coupling_approximation} and solving for $q$. We further use ~\cref{eq:m3:theory:q_rewrite} and solve for $\tau'(1+R^{-1})(3\T_1+v_b)$ which we substitute into ~\cref{eq:m3:theory:v_b} in order to obtain an equation for $v_b'$. Altogether, this give rise to the following equations, valid in the tight coupling regime:
    \begin{tcolorbox}[
        width=1.025\linewidth,
        colback=blue!5!white,
        colframe=white
    ]
    \textbf{Tight coupling equations}
    \begin{equation}\label{eq:m3:theory:tight_coupling_q}
        \begin{split}
            q&\left[(1+R^{-1})\tau'+\frac{\Hp'}{\Hp}-1\right] = \\
            &- \left[\tau''\left(1+R^{-1}\right)+\left(1-R^{-1}\right)\tau'\right](3\T_1+v_b) \\
            &- \frac{ck}{\Hp}\Psi+\left(1-\frac{\Hp'}{\Hp}\right)\frac{ck}{\Hp}(-\T_0+2\T_2)-\frac{ck}{\Hp}\T_0'
        \end{split}
    \end{equation}
    \\
    \begin{equation}\label{eq:m3:theory:tight_coupling_v_b}
        \begin{split}
            v_b'&\left[1+R^{-1}\right] = -v_b-\frac{ck}{\Hp}\Psi\\
            &+R^{-1}\left(q+\frac{ck}{\Hp}(-\T_0+2\T_2)-\frac{ck}{\Hp}\Psi\right)
        \end{split}
    \end{equation}
    \\
    \begin{subequations}\label{eq:m3:theory:tight_coupling_all_poles}
        \begin{align}
            \T_1' &= \frac{1}{3}(q-v_b'), \label{eq:m3:theory:tight_coupling_monopole}\\
            \T_2 &= -\frac{20ck}{45\Hp\tau'}\T_1, \label{eq:m3:theory:tight_coupling_dipole}\\
            \T_l &= -\frac{l}{2l+1}\frac{ck}{\Hp\tau'}\T_{l-1} \quad l>2. \label{eq:m3:theory:tight_coupling_multipole}
        \end{align}
    \end{subequations}
    \end{tcolorbox}
    \subsubsection{Inflation}
    To be able to numerically integrate ~\cref{eq:m3:theory:photon_temp_multipoles}, ~\cref{eq:m3:theory:cdm_baryon_diffeqs} and ~\cref{eq:m3:theory:metric_perturbations_final} we must determine the initial conditions of each quantity. Thus, we need to know how the Universe behaved at a very early stage. It is proposed that an epoch called \textit{inflation} took place, during which the Universe exponentially increases in size during a very short period of time ~\cite{dodelson2020modern}.\footnote{An inflationary process would also solve the horizon problem, the flatness problem and the monopole problem amongst other things. Details about this can be found in both ~\cite{dodelson2020modern}, ~\cite{carroll_2019}, and ~\cite{weinberg2008cosmology}.} We will describe the inflationary period in order to obtain the initial conditions of the metric perturbations $\Psi$ and $\Phi$. 

    Assume inflation is driven by a scalar field $\psi(t,\vec{x})$, typically referred to as \textit{inflaton field}. For inflation to happen, the acceleration of the scale factor must be positive, meaning that the inflaton field must model a fluid where the equation of state parameter $\omega$ is negative, i.e. $3p+\rho<0$. By considering the temporal and spatial part of the energy-momentum tensor, ~\cite{dodelson2020modern} obtains the following equations for the pressure and density of the inflaton field:
    \begin{equation}\label{eq:m3:theory:inflaton_density}
        \rho_\phi = \frac{1}{2}\left(\dv{\phi}{t}\right)^2+V(\phi),
    \end{equation}
    and 
    \begin{equation}\label{eq:m3:theory:inflaton_pressure}
        p_\phi = \frac{1}{2}\left(\dv{\phi}{t}\right)^2-V(\phi),
    \end{equation}
    where $1/2\left(\dv{\phi}{t}\right)^2$ is the kinetic energy of the field, and $V(\phi)$ is the potential energy. Thus, $\omega = p/\rho < 0$ implies that the inflaton field must have more potential than kinetic energy. We therefore require it to \textit{roll slowly} in the potential, and thus introduce the \textit{slow roll parameters} $\epsilon_\mathrm{sr}$ and $\delta_\mathrm{sr}$, both of which must be satisfied for the field to be able to perform inflation. These are:
    \begin{subequations}\label{eq:m3:theory:slow_roll_parameters}
        \begin{align}
            \epsilon_\mathrm{sr} &= \frac{E_\mathrm{pl}^2}{16\pi}\left(\frac{V'}{V}\right)^2 \ll1 \label{eq:m3:theory:slow_roll_epsilon}\\
            \delta_\mathrm{sr} &= \frac{E_\mathrm{pl}}{8\pi}\left( \frac{V''}{V}\right) \ll1,\label{eq:m3:theory:slow_roll_delta}
        \end{align}
    \end{subequations}
    where the derivative of the potential $V$ is in terms of $\phi$. 

    Next, one of the crucial assumptions is that we can express the inflaton field in terms of a perturbation (or overdensity) as:
    \begin{equation}\label{eq:m3:theory:inflaton_field_perturb}
        \phi(t,\vec{x}) = \phi^{(0)}(t) + \delta\phi(t, \vec{x}),
    \end{equation}
    where $\phi^{(0)}$ is the equilibrium value of the field, only dependent on time. We will concern ourselves with the perturbation $\delta\phi$ and investigate what happens to it during the inflationary period. Before inflation, we expect $\Psi = \Phi =0$ and the perturbation $\delta\phi$ to be of quantum nature. 

    \TODO{fill more here maybe}

    We could in principle solve the full Einstein equation where $\Psi$ and $\Phi$ enters through the Einstein tensor, and $\phi$ through the energy-momentum tensor.\footnote{The energy-momentum tensor for $\phi$ is given in ~\cite[Eq. 7.6]{dodelson2020modern} as: $$ T^\alpha_{\;\;\beta}=g^{\alpha\nu}\pdv{\phi}{x^\nu}\pdv{\phi}{x^\beta}-\delta^\alpha_{\;\;\beta}\left[\frac{1}{2}g^\munu\pdv{\phi}{x^\mu}\pdv{\phi}{x^\nu}+V(\phi)\right]. $$} This is not trivial, and instead we introduce the curvature perturbation $\mathcal{R}(\delta\phi, \Psi)$, which is a conserved quantity, as ~\cite{dodelson2020modern}:
    \begin{equation}\label{eq:m3:theory:curvature_perturbation_def}
        \mathcal{R} = -\frac{ik_i\delta T^0_i}{k^2(p+\rho)}-\Psi,
    \end{equation}
    where $k$ is the mode (in Fourier space), $T^i_0 = g^{i\nu}=\partial_\nu\phi\partial_0\phi$ is the spatial part of the energy-momentum tensor, and $p$ and $\rho$ are the pressure and density. 

    If we consider the situation before inflation, assume $\Psi=0$. From ~\cref{eq:m3:theory:slow_roll_parameters} we have that $\rho+p=\dot{\phi}^2/a^2$ using conformal time. Further, according to ~\cite[Eq. 7.47]{dodelson2020modern}, $\delta T^i_0=ik_i\dot{\phi}\delta\phi/a^3$. Inserting this into ~\cref{eq:m3:theory:curvature_perturbation_def} yield before inflation:
    \begin{equation}\label{eq:m3:theory:initial_curvature_perturbation}
        \mathcal{R}_\mathrm{initial} = -aH\frac{\delta\phi}{\dot{\phi}}.
    \end{equation}
    Looking at the same situation at the end of inflation, we now assume radiation domination: $p=\rho/3$. According to ~\cite{dodelson2020modern}, $ik_i\delta T^i_0 = -4k\rho_\gamma\T_1/a$ in the radiation dominated era. Inserting this into ~\cref{eq:m3:theory:curvature_perturbation_def} yield:
    \begin{equation}\label{eq:m3:theory:final_curvature_perturbation}
        \mathcal{R}_\mathrm{end} = -\frac{3aH\T_1}{k}-\Psi = -\frac{3}{2}\Psi,
    \end{equation}
    where the last equality comes from the postulate that the initial condition for the dipole is $\T_1=-k\Phi/6aH$, which will we showed in the following section. For the sake of completeness, we not equate ~\cref{eq:m3:theory:initial_curvature_perturbation} and ~\cref{eq:m3:theory:final_curvature_perturbation} to obtain:
    \begin{equation}\label{eq:m3:theory:final_Psi_after_inflation}
        \Psi = \frac{2}{3}aH\frac{\delta\phi}{\dot{\phi}}\Big|_\text{horizon crossing},
    \end{equation}
    which is the value of $\Psi$ immediately after inflation, when the mode is of equal size as the horizon (hence horizon crossing). \TODO{check if this actually is correct}

    \subsubsection{Initial conditions}
        We now seek to determine the actual initial conditions enabling us to solve the desired differential equations. At very early times, we make the following assumptions:
        \begin{subequations}\label{eq:m3:theory:early_conditions}
            \begin{align}
                k\eta &\ll 1 \iff \frac{k}{\Hp}\ll1\label{eq:m3:theory:early_conditions_kmode_eta}\\
                \tau &\gg 1 \text{ and } \abs{\tau'}\gg1 \label{eq:m3:theory:earl_conditions_tau} \\
                \T_0&\gg\T_1\gg\T_2\gg\dots\gg\T_l \label{eq:m3:theory:early_conditions_theta}.
            \end{align}
        \end{subequations}
        ~\cref{eq:m3:theory:early_conditions_kmode_eta} is necessary in order to ensure causally disconnected regions in the early universe. It also ensures that the modes we are interested in today is outside the horizon ~\cite{AST5220LectureNotes}. We have already established that the universe is optically thick, so ~\cref{eq:m3:theory:earl_conditions_tau} follow directly from ~\cref{fig:m2:optical_depth}. Further, at these scales we expect the lower multipoles to be dominant, thus ~\cref{eq:m3:theory:early_conditions_theta} holds. This is because the causal horizon is smaller than the $k$-modes, making the radiation observed by an hypothetical observer nearly uniform. Applying the assumptions in ~\cref{eq:m3:theory:early_conditions} to ~\cref{eq:m3:theory:photon_temp_multipoles}, ~\cref{eq:m3:theory:cdm_baryon_diffeqs} and ~\cref{eq:m3:theory:metric_perturbations_final} allows to determine the initial conditions. 

        Firstly, the perturbations of $\Phi$ and $\Psi$ evolves slowly outside the horizon, so we may approximate $\Phi'=\Psi'=0$. However, we will use their expression in order to determine other initial conditions. In the following we make use of the assumptions in ~\cref{eq:m3:theory:early_conditions}. ~\cref{eq:m3:theory:photon_monopole} becomes $\T_0'=-\Phi'$. Further, ~\cref{eq:m3:theory:phi_perturbation} turn into $\Phi'=\Psi+2\T_0 \implies \T_0=-\Psi/2$. The overdensities ~\cref{eq:m3:theory:delta_b} and ~\cref{eq:m3:theory:delta_cdm} have similar behaviour\footnote{Because gravity does not care whether it acts on baryons or dark matter.} and we write $\delta'=-3\Phi' = 3\T_0'$. Integrating both sides yield $\delta=-3\Psi/2 + C$, where $C$ is the integration constant. This is put to zero, making the initial conditions \textit{adiabatic}. ~\cref{eq:m3:theory:psi_perturbation} now fixes the relation between the initial conditions of $\Psi$ and $\Phi$ as $\Phi = -\Psi$. 

        For the velocities, we expect the baryon and cold dark matter velocities to have the same initial value, and we find it by considering ~\cref{eq:m3:theory:v_cdm}, which can be written as $(va)'=-cka\Psi/\Hp$. Integration yields $v=-ck\Psi/2\Hp$ where we have omitted the constant of integration. We find the initial conditions for the next multipole terms by following a similar logic. This is also shown in ~\cite[Eq. 7.59]{dodelson2020modern} which fixes the velocities as $v=3ck\Phi/6\Hp$,\footnote{~\cite{dodelson2020modern} uses $iv$ as velocities, but we have multiplied the velocities with $i$ in order to make them real, but ultimately changing signs.} and gives the initial dipole moment $\T_1 = -k\Phi/6aH$. Inserting this into ~\cref{eq:m3:theory:final_curvature_perturbation} yields the desired $\mathcal{R}=-2\Psi/2$. Since $\mathcal{R}$ is conserved, choosing a value for it equations to fixing a normalisation. We will simply use $\mathcal{R}=1$. The full set of adiabatic initial conditions then become: 
        
        \begin{tcolorbox}[
            width=1.025\linewidth,
            colback=blue!5!white,
            colframe=white
            ]
            \textbf{Initial conditions}
            \begin{subequations}\label{eq:m3:theory:initial_conditions}
                \begin{align}
                    \Psi &= -\frac{2}{3}, \label{eq:m3:theory:initial_conditions_Psi}\\
                    \Phi &= -\Psi, \label{eq:m3:theory:initial_conditions_Phi}\\
                    \delta_c &= \delta_b = -\frac{3}{2}\Psi, \label{eq:m3:theory:initial_conditions_deltas}\\
                    v_c &= v_b = -\frac{ck}{2\Hp}\Psi, \label{eq:m3:theory:initial_conditions_vs}\\ 
                    \T_0 &= -\frac{1}{2}\Psi, \label{eq:m3:theory:initial_conditions_monopole}\\
                    \T_1 &= \frac{ck}{6\Hp}\Psi, \label{eq:m3:theory:initial_conditions_dipole}\\
                    \T_2 &= -\frac{20ck}{45\Hp\tau'}\T_1, \label{eq:m3:theory:initial_conditions_quadrapole}\\
                    \T_l &= -\frac{l}{2l+1}\frac{ck}{\Hp\tau'}\T_{l-1}.\label{eq:m3:theory:initial_conditions_multipoles}
                \end{align}
            \end{subequations}
        \end{tcolorbox}

\subsubsection{Line of sight integration}

    \begin{equation}\label{eq:m3:theory:line_of_sight_integral_definition}
        \T_l(k,x=0) = \int_{-\infty}^0 \mathcal{S}(k,x)j_l\left[k(\eta_0-\eta(x))\right]\d x,
    \end{equation}
    where $j_l\left[k(\eta_0-\eta(x))\right]$ are the spherical Bessel functions. $\mathcal{S}(k,x)$ is known as the \textit{source function} as is given by:
    
    \begin{equation}\label{eq:m3:theory:source_function}
        \begin{split}
            \mathcal{S}(k,x) &= \tilde{g}\left[\T_0+\Psi+\frac{\T_2}{4}\right] + e^{-\tau}\left[\Psi'-\Phi'\right]\\
            &-\frac{1}{ck}\dv{}{x}\left[\Hp\tilde{g}v_b\right] + \frac{3}{4c^2k^2}\dv{}{x}\left[\Hp\dv{}{x}\left(\Hp\tilde{g}\T_2\right)\right].
        \end{split}
    \end{equation}
    Due to the nature of the product rule, ~\cref{eq:m3:theory:source_function} end up containing a lot of terms. We state the individual result of the differentiated terms below:
    \begin{equation}\label{eq:m3:theory:dvHgv_b}
        \dv{}{x}\left[\Hp\tilde{g}v_b\right] = \Hp\tilde{g}v_b' + \Hp\tilde{g}'v_b + \Hp'\tilde{g}v_b
    \end{equation}
    and
    \begin{equation}\label{eq:m3:theory:dvHdvHgT}
        \begin{split}
            \dv{}{x}\left[\Hp\dv{}{x}\left(\Hp\tilde{g}\T_2\right)\right] &= \tilde{g}\T_2\left[\Hp''\Hp + \left(\Hp'\right)^2\right] \\
            &+\Hp^2\left[\tilde{g}\T_2'' + \tilde{g}''\T_2 + 2\tilde{g}'\T_2'\right] \\
            &+3\Hp'\Hp\left[\tilde{g}\T_2'+\tilde{g}'\T_2\right].
        \end{split}
    \end{equation}
    In order to find $\T_2''$ we insert $l=2$ in ~\cref{eq:m3:theory:photon_multipole} and differentiate:
    \begin{equation}\label{eq:m3:theory:dipole_double_deriv}
        \begin{split}
            \T_2'' &= \dv{}{x}\left[\frac{2ck}{5\Hp}\T_1-\frac{3ck}{5\Hp}\T_3 + \tau'\left(\T_2-\frac{\T_2}{10}\right)\right] \\
            &= \frac{2ck}{\Hp}\left(\T_1'-\frac{\Hp'}{\Hp}\T_1\right) + \frac{3ck}{5\Hp}\left(\frac{\Hp'}{\Hp}\T_3 - \T_3'\right)\\
            &+ \frac{9}{10}\left(\tau''\T_2 + \tau'\T_2'\right)
        \end{split}
    \end{equation}


